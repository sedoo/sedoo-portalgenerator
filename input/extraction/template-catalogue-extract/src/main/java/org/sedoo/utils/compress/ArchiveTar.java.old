package org.sedoo.utils.compress;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

import org.apache.log4j.Logger;
import org.apache.tools.tar.TarEntry;
import org.apache.tools.tar.TarInputStream;
import org.apache.tools.tar.TarOutputStream;

/**
 * Classe pour la manipulation d'une archive Tar.
 * @author brissebr
 */
public class ArchiveTar implements Archive {

private final static Logger logger = Logger.getLogger(ArchiveTar.class);
	
	private File file;
	private boolean compress;
			
	private TarOutputStream out;
	private TarInputStream in;
	private byte[] data = new byte[ BUFFER_SIZE ];
	
	
	/**
	 * Constructeur.
	 * @param filename nom de l'archive
	 * @param compress indique si l'archive doit �tre compress�e avec gzip.
	 */
	public ArchiveTar(String filename, boolean compress){
		this(new File(filename),compress);
	}
	/**
	 * Constructeur (archive non compress�e).
	 * @param filename
	 */
	public ArchiveTar(String filename){
		this(filename,false);
	}
	/**
	 * Constructeur.
	 * @param file archive
	 * @param compress indique si l'archive est compress�e avec gzip.
	 */
	public ArchiveTar(File file, boolean compress){
		this.file = file;
		this.compress = compress;
	}
	/**
	 * Constructeur (archive non compress�e).
	 * @param file archive
	 */
	public ArchiveTar(File file){
		this(file,false);
	}
	
	/**
	 * @see Archive#openWrite()
	 */
	public void openWrite() throws IOException {
		close();
		if (compress){
			this.out = new TarOutputStream(new GZIPOutputStream(new BufferedOutputStream(new FileOutputStream(file))));
		}else{
			this.out = new TarOutputStream(new BufferedOutputStream(new FileOutputStream(file)));
		}
		//Pour r�soudre le probl�me suivant : file name '...' is too long ( > 100 bytes)
		out.setLongFileMode(TarOutputStream.LONGFILE_GNU);
		
	}
	
	private void openRead() throws IOException {
		close();
		if (compress){
			this.in = new TarInputStream(new GZIPInputStream(new BufferedInputStream(new FileInputStream(file))));
		}else{
			this.in = new TarInputStream(new BufferedInputStream(new FileInputStream(file)));
		}
	}
	/**
	 * @see Archive#close()
	 */
	public void close() throws IOException {
		if (out != null){
			this.out.close();
		}
		if (in != null){
			this.in.close();
		}
		this.out = null;
		this.in = null;
	}
	/**
	 * @see Archive#addEntry(File)
	 */
	public boolean addEntry(File entry) throws IOException{
		return addEntry(entry,true,false);
	}
	
	/**
	 * @see Archive#addEntry(File,File)
	 */
	public boolean addEntry(File entry, File rootPath) throws IOException{
		return addEntry(entry,rootPath,false);
	}
	/**
	 * @see Archive#addEntry(File, boolean)
	 */
	public boolean addEntry(File entry, boolean storePath) throws IOException{
		return addEntry(entry,storePath,false);
	}
	
	public boolean addEntry(File entry, boolean storePath, boolean delete) throws IOException {
		return addEntry(entry,storePath,null,delete);		
	}
	
	public boolean addEntry(File entry, File rootPath, boolean delete) throws IOException {
		return addEntry(entry,true,rootPath,delete);		
	}
	
	/**
	 * @see Archive#addEntry(File, boolean, boolean)
	 */
	public boolean addEntry(File entry, boolean storePath, File rootPath, boolean delete) throws IOException {
		if (out == null){
			throw new IOException("Tar archive is not opened for writing");
		}
		try{
						
			BufferedInputStream origin = null;
			
			String entryName = null;
			long entrySize = entry.length();
			if (storePath){
				if (rootPath == null){
					entryName = entry.getPath();
				}else{
					entryName = entry.getAbsolutePath().replaceFirst(rootPath.getAbsolutePath(), "");
				}
			}else
				entryName = entry.getName();
			
			if (entry.getName().endsWith(".gz")){
				try{
					origin = new BufferedInputStream(new GZIPInputStream(new FileInputStream(entry), BUFFER_SIZE));
					entryName = entryName.substring(0,entryName.length()-3);
					entrySize = ArchiveUtils.getGZipUncompressedSize(entry);
					logger.debug("Uncompressed size: " + entrySize);
				}catch(IOException e){
					logger.warn(e);
					logger.warn("MIME Type: " + ArchiveUtils.getMIMEType(entry));
					origin = new BufferedInputStream( new FileInputStream(entry), BUFFER_SIZE);
				}				
			}else{
				origin = new BufferedInputStream( new FileInputStream(entry), BUFFER_SIZE);
			}
			TarEntry tarEntry = new TarEntry(entryName);
			tarEntry.setSize(entrySize);
			
			out.putNextEntry(tarEntry);
			int count;
			while( ( count = origin.read(data, 0, BUFFER_SIZE ) ) != -1 ){
				out.write(data, 0, count);
			}
			origin.close();		
			
			out.closeEntry();
			
			if (delete){
				if(entry.delete()){
					logger.debug("File successfully deleted");
				}else{
					logger.warn("File not deleted");
				}
			}
		}catch(IOException e){
			logger.warn("Error while adding file to archive. Cause: "+e);
			return false;
		}
		return true;
	}
	/**
	 * @see Archive#extract(String)
	 */
	public void extract(String directory) throws IOException{
		logger.debug("extract()");

		openRead();		
		int count;
		TarEntry entry;
		while( ( entry = in.getNextEntry() ) != null ){
			logger.debug("Entry: "+entry.getName());
			if( !entry.isDirectory() ){
				if (!directory.endsWith(File.separator)){
					directory += File.separator;
				}

				File destFile = new File(directory + entry.getName());
				if (destFile.getParentFile() != null){
					destFile.getParentFile().mkdirs();
				}
				BufferedOutputStream dest = new BufferedOutputStream(new FileOutputStream(destFile), BUFFER_SIZE );
				while( (count = in.read( data, 0, BUFFER_SIZE ) ) != -1 ) {
					dest.write( data, 0, count );
				}
				dest.close();
			}
		}

	}

}
